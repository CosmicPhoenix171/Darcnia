name: Update Version on Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate version file
      run: |
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        COMMIT_FULL=$(git rev-parse HEAD)
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        cat > darcnia-campaign/web/js/version.js << EOF
        // Auto-generated version from build process
        // DO NOT EDIT - This file is updated automatically by GitHub Actions
        window.APP_VERSION = 'v1.25-${COMMIT_SHORT}';
        window.BUILD_TIME = '${BUILD_TIME}';
        window.GIT_COMMIT = '${COMMIT_FULL}';
        window.GIT_COMMIT_SHORT = '${COMMIT_SHORT}';
        EOF
        
        echo "Generated version.js with commit ${COMMIT_SHORT}"
        cat darcnia-campaign/web/js/version.js
    
    - name: Commit version file
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add darcnia-campaign/web/js/version.js
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update version.js [skip ci]"
        git push
